#!/bin/bash
set -e

SOURCE=$(cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && cd .. && pwd)
PATH=$SOURCE/bin:$PATH
JENKINS_URL=http://localhost:8080
JENKINS_HOME=/var/jenkins_home
TEST_CONTAINER=$(docker run -d --rm \
    -v $SOURCE/testdata/jobs:$JENKINS_HOME/jobs \
    -p 8080:8080 \
    -e JAVA_OPTS='-Djenkins.install.runSetupWizard=false -Djenkins.install.SetupWizard.adminInitialApiToken=api_token -Dhudson.security.csrf.DefaultCrumbIssuer.EXCLUDE_SESSION_ID=true' \
    -e JENKINS_HOME=$JENKINS_HOME \
    jenkins/jenkins)

wait_for_jenkins $JENKINS_URL

docker build \
    --target tests \
    --build-arg JENKINS_URL=$JENKINS_URL \
    --build-arg JENKINS_JOB=jenkins-job-resource-test \
    --build-arg JENKINS_JOB_TOKEN=job_token \
    --build-arg JENKINS_USERNAME=admin \
    --build-arg JENKINS_API_TOKEN=api_token \
    -f dockerfiles/ubuntu/Dockerfile  \
    --network host .

docker stop $TEST_CONTAINER
